substitutions:
  _AR_REGION: "asia-southeast1"
  _AR_REPO: "app-repo"
  _IMAGE_NAME: "asb-ml-app"
  _SERVICE_NAME: "asb-ml-app"
# cloudbuild.yaml
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa', '.']
  # If your Dockerfile needs GEMINI_API_KEY during the build stage,
  # you would typically pass it as a build-arg, not directly as an env var to docker build.
  # Example for build-arg (requires ARG in Dockerfile):
  # args: ['build', '--build-arg', 'GEMINI_API_KEY=${_GEMINI_API_KEY}', '-t', '...', '.']
  # env:
  # - 'GEMINI_API_KEY=${_GEMINI_API_KEY}' # This makes it available as an env var FOR THIS STEP.
                                        # Only add if `docker build` command or pre/post hooks need it.

- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa']

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    # This script runs within the environment of this step.
    # The GEMINI_API_KEY environment variable will be available here
    # because it's defined in the 'env' section for this step below.
    # When deploying to Cloud Run, use $$ for Cloud Run's env vars.
    gcloud run deploy asb-ml-app \
      --image asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa \
      --region asia-southeast1 \
      --platform managed \
      --allow-unauthenticated \
      --memory 2Gi \
      --cpu 2 \
      --timeout 600 \
      --concurrency 5 \
      --set-env-vars GEMINI_API_KEY=$$GEMINI_API_KEY # <-- This is where it's used
  env: # <--- This is the crucial part that was likely missing or incorrect for this step
  - 'GEMINI_API_KEY=${_GEMINI_API_KEY}' # Map the internal secret to an env var for this step

# This section correctly declares which secret to fetch from Secret Manager
availableSecrets:
  secretManager:
  - versionName: projects/ecgcga/secrets/gemini-api-key/versions/latest
    env: '_GEMINI_API_KEY' # This makes the secret's value available internally as _GEMINI_API_KEY
# Optional: automatically set environment variables or secrets (uncomment if needed)
#   - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
#     entrypoint: gcloud
#     args:
#       [
#         "run",
#         "services",
#         "update",
#         "${_SERVICE_NAME}",
#         "--region",
#         "${_AR_REGION}",
#         "--update-env-vars",
#         "GEMINI_API_KEY=YOUR_API_KEY_HERE"
#       ]

#   - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
#     entrypoint: gcloud
#     args:
#       [
#         "run",
#         "services",
#         "update",
#         "${_SERVICE_NAME}",
#         "--region",
#         "${_AR_REGION}",
#         "--update-secrets",
#         "GEMINI_API_KEY=gemini_api_key:latest"
#       ]

# Fixes “invalid build: must specify logs bucket or logging option”
options:
  logging: CLOUD_LOGGING_ONLY

# Control build timeout (up to 1h by default)
timeout: 1200s
