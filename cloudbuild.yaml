substitutions:
  _AR_REGION: "asia-southeast1"
  _AR_REPO: "app-repo"
  _IMAGE_NAME: "asb-ml-app"
  _SERVICE_NAME: "asb-ml-app"
# cloudbuild.yaml
# cloudbuild.yaml
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa', '.']
  # If your Dockerfile needs GEMINI_API_KEY as a build-arg:
  # args: ['build', '--build-arg', 'GEMINI_API_KEY=$${GEMINI_API_KEY}', '-t', 'asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa', '.']
  # env:
  # - 'GEMINI_API_KEY=${_GEMINI_API_KEY}' # Temporarily make it an environment variable for this step
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa']
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    # In this script, GEMINI_API_KEY will be available as a shell environment variable
    # when it's passed from the `env` section below.
    # If your application needs it during deployment, set it for Cloud Run here:
    gcloud run deploy asb-ml-app \
      --image asia-southeast1-docker.pkg.dev/ecgcga/app-repo/asb-ml-app:3f3c1fa \
      --region asia-southeast1 \
      --platform managed \
      --allow-unauthenticated \
      --memory 2Gi \
      --cpu 2 \
      --timeout 600 \
      --concurrency 5 \
      --set-env-vars GEMINI_API_KEY=$$GEMINI_API_KEY # Use $$ to pass to Cloud Run
  env:
  - 'GEMINI_API_KEY=${_GEMINI_API_KEY}' # This maps the secret value to an env var for THIS step

# This section tells Cloud Build to fetch the secret
availableSecrets:
  secretManager:
  - versionName: projects/ecgcga/secrets/gemini-api-key/versions/latest # Your project ID
    env: '_GEMINI_API_KEY' # Internal name for the secret's value within Cloud Build


# Optional: automatically set environment variables or secrets (uncomment if needed)
#   - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
#     entrypoint: gcloud
#     args:
#       [
#         "run",
#         "services",
#         "update",
#         "${_SERVICE_NAME}",
#         "--region",
#         "${_AR_REGION}",
#         "--update-env-vars",
#         "GEMINI_API_KEY=YOUR_API_KEY_HERE"
#       ]

#   - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
#     entrypoint: gcloud
#     args:
#       [
#         "run",
#         "services",
#         "update",
#         "${_SERVICE_NAME}",
#         "--region",
#         "${_AR_REGION}",
#         "--update-secrets",
#         "GEMINI_API_KEY=gemini_api_key:latest"
#       ]

# Fixes “invalid build: must specify logs bucket or logging option”
options:
  logging: CLOUD_LOGGING_ONLY

# Control build timeout (up to 1h by default)
timeout: 1200s
